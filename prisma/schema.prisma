generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 單字檔案
model WordFile {
  id        String   @id @default(cuid())
  name      String
  words     Word[]
  createdAt DateTime @default(now())
}

// 單字
model Word {
  id           String    @id @default(cuid())
  english      String
  chinese      String
  partOfSpeech String?
  fileId       String
  file         WordFile  @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@index([fileId])
}

// 學生角色
model Profile {
  id            String         @id @default(cuid())
  name          String
  createdAt     DateTime       @default(now())
  stars         Int            @default(0)          // 目前星星幣
  totalStars    Int            @default(0)          // 歷史總獲得星星
  lastLoginAt   DateTime?                           // 最後登入時間
  loginStreak   Int            @default(0)          // 連續登入天數
  equippedFrame String?                             // 裝備的頭像框
  equippedTheme String?                             // 裝備的主題
  equippedTitle String?                             // 裝備的稱號
  lastSpinAt    DateTime?                           // 上次轉盤時間
  progress      FileProgress[]
  quizSessions  QuizSession[]
  masteredWords MasteredWord[]
  dailyQuests   DailyQuest[]
  badges        ProfileBadge[]
  purchases     ProfilePurchase[]
  pet           Pet?
  titles        ProfileTitle[]
  chests        ProfileChest[]
  stickers      ProfileSticker[]
}

// 檔案學習進度
model FileProgress {
  id          String   @id @default(cuid())
  profileId   String
  fileId      String
  correct     Int      @default(0)
  wrong       Int      @default(0)
  weakWordIds String[] @default([])
  profile     Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  history     ProgressHistory[]

  @@unique([profileId, fileId])
  @@index([profileId])
}

// 進度歷史
model ProgressHistory {
  id             String       @id @default(cuid())
  fileProgressId String
  rate           Int
  timestamp      DateTime     @default(now())
  fileProgress   FileProgress @relation(fields: [fileProgressId], references: [id], onDelete: Cascade)

  @@index([fileProgressId])
}

// 測驗記錄
model QuizSession {
  id             String   @id @default(cuid())
  profileId      String
  fileId         String
  customQuizId   String?              // 自訂測驗 ID（可選）
  customQuizName String?              // 自訂測驗名稱（可選，冗餘儲存以防測驗被刪除）
  timestamp      DateTime @default(now())
  duration       Int
  completed      Boolean
  profile        Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  results        QuizResult[]

  @@index([profileId])
}

// 測驗結果詳情
model QuizResult {
  id           String      @id @default(cuid())
  sessionId    String
  wordId       String
  correct      Boolean
  questionType Int
  timeSpent    Int
  session      QuizSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

// 已精熟單字（間隔重複系統）
model MasteredWord {
  id             String   @id @default(cuid())
  profileId      String
  wordId         String
  level          Int      @default(1)        // 精熟等級 (1-6)
  masteredAt     DateTime @default(now())    // 首次精熟時間
  lastReviewedAt DateTime @default(now())    // 最後複習時間
  nextReviewAt   DateTime @default(now())    // 下次應複習時間
  reviewCount    Int      @default(0)        // 總複習次數
  correctStreak  Int      @default(0)        // 連續答對次數
  profile        Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([profileId, wordId])
  @@index([profileId])
  @@index([nextReviewAt])                    // 方便查詢待複習單字
}

// 系統設定（全域）
model Settings {
  id                    String @id @default("global")
  teacherPassword       String @default("1234")
  timePerQuestion       Int    @default(10)              // 舊欄位，向後相容
  timeChoiceQuestion    Int    @default(10)              // 選擇題時間（秒）
  timeSpellingQuestion  Int    @default(30)              // 拼寫題時間（秒）
  questionCount         Int    @default(0)
  questionTypes         Int[]  @default([0, 1, 2, 3])    // 預設啟用所有題型
}

// 自訂測驗
model CustomQuiz {
  id            String   @id @default(cuid())
  name          String                          // 測驗名稱
  fileId        String                          // 來源單字檔案
  wordIds       String[]                        // 選中的單字 ID
  questionTypes Int[]    @default([0, 1])       // 啟用的題型
  active        Boolean  @default(true)         // 是否啟用
  createdAt     DateTime @default(now())

  @@index([active])
}

// 每日任務
model DailyQuest {
  id             String   @id @default(cuid())
  profileId      String
  date           DateTime @db.Date              // 任務日期
  // 任務 1
  quest1Type     String                         // quiz_count, review_count, correct_streak, accuracy
  quest1Target   Int                            // 目標數量
  quest1Progress Int      @default(0)           // 目前進度
  quest1Reward   Int      @default(5)           // 星星獎勵
  quest1Done     Boolean  @default(false)       // 是否完成
  // 任務 2
  quest2Type     String
  quest2Target   Int
  quest2Progress Int      @default(0)
  quest2Reward   Int      @default(5)
  quest2Done     Boolean  @default(false)
  // 任務 3
  quest3Type     String
  quest3Target   Int
  quest3Progress Int      @default(0)
  quest3Reward   Int      @default(10)
  quest3Done     Boolean  @default(false)
  // 全部完成獎勵
  allCompleted   Boolean  @default(false)
  bonusClaimed   Boolean  @default(false)       // 全完成額外獎勵是否已領取

  profile        Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([profileId, date])
  @@index([profileId])
}

// 已解鎖徽章
model ProfileBadge {
  id         String   @id @default(cuid())
  profileId  String
  badgeId    String                           // 徽章 ID（對應程式碼中定義的徽章）
  unlockedAt DateTime @default(now())

  profile    Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([profileId, badgeId])
  @@index([profileId])
}

// 已購買商品
model ProfilePurchase {
  id          String   @id @default(cuid())
  profileId   String
  itemId      String                           // 商品 ID（對應程式碼中定義的商品）
  purchasedAt DateTime @default(now())

  profile     Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([profileId, itemId])
  @@index([profileId])
}

// 虛擬寵物
model Pet {
  id          String   @id @default(cuid())
  profileId   String   @unique
  name        String   @default("小龍")        // 寵物名字
  species     String   @default("dragon")      // 物種 (dragon, cat, dog, etc.)
  exp         Int      @default(0)             // 經驗值
  level       Int      @default(1)             // 等級
  stage       Int      @default(1)             // 進化階段 (1-5)
  hunger      Int      @default(100)           // 飽足度 (0-100)
  happiness   Int      @default(100)           // 快樂度 (0-100)
  lastFedAt   DateTime @default(now())         // 上次餵食時間
  createdAt   DateTime @default(now())

  profile     Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
}

// 已解鎖稱號
model ProfileTitle {
  id         String   @id @default(cuid())
  profileId  String
  titleId    String                           // 稱號 ID
  unlockedAt DateTime @default(now())

  profile    Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([profileId, titleId])
  @@index([profileId])
}

// 寶箱庫存
model ProfileChest {
  id        String @id @default(cuid())
  profileId String
  chestType String // bronze, silver, gold, diamond
  quantity  Int    @default(1)

  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([profileId, chestType])
  @@index([profileId])
}

// 貼紙收集
model ProfileSticker {
  id         String   @id @default(cuid())
  profileId  String
  stickerId  String                           // 貼紙 ID
  obtainedAt DateTime @default(now())

  profile    Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([profileId, stickerId])
  @@index([profileId])
}
