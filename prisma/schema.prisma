generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 單字檔案
model WordFile {
  id        String   @id @default(cuid())
  name      String
  words     Word[]
  createdAt DateTime @default(now())
}

// 單字
model Word {
  id           String    @id @default(cuid())
  english      String
  chinese      String
  partOfSpeech String?
  fileId       String
  file         WordFile  @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@index([fileId])
}

// 學生角色
model Profile {
  id           String         @id @default(cuid())
  name         String
  createdAt    DateTime       @default(now())
  progress     FileProgress[]
  quizSessions QuizSession[]
  masteredWords MasteredWord[]
}

// 檔案學習進度
model FileProgress {
  id          String   @id @default(cuid())
  profileId   String
  fileId      String
  correct     Int      @default(0)
  wrong       Int      @default(0)
  weakWordIds String[] @default([])
  profile     Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  history     ProgressHistory[]

  @@unique([profileId, fileId])
  @@index([profileId])
}

// 進度歷史
model ProgressHistory {
  id             String       @id @default(cuid())
  fileProgressId String
  rate           Int
  timestamp      DateTime     @default(now())
  fileProgress   FileProgress @relation(fields: [fileProgressId], references: [id], onDelete: Cascade)

  @@index([fileProgressId])
}

// 測驗記錄
model QuizSession {
  id        String   @id @default(cuid())
  profileId String
  fileId    String
  timestamp DateTime @default(now())
  duration  Int
  completed Boolean
  profile   Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  results   QuizResult[]

  @@index([profileId])
}

// 測驗結果詳情
model QuizResult {
  id           String      @id @default(cuid())
  sessionId    String
  wordId       String
  correct      Boolean
  questionType Int
  timeSpent    Int
  session      QuizSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

// 已精熟單字（間隔重複系統）
model MasteredWord {
  id             String   @id @default(cuid())
  profileId      String
  wordId         String
  level          Int      @default(1)        // 精熟等級 (1-6)
  masteredAt     DateTime @default(now())    // 首次精熟時間
  lastReviewedAt DateTime @default(now())    // 最後複習時間
  nextReviewAt   DateTime @default(now())    // 下次應複習時間
  reviewCount    Int      @default(0)        // 總複習次數
  correctStreak  Int      @default(0)        // 連續答對次數
  profile        Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([profileId, wordId])
  @@index([profileId])
  @@index([nextReviewAt])                    // 方便查詢待複習單字
}

// 系統設定（全域）
model Settings {
  id                    String @id @default("global")
  teacherPassword       String @default("1234")
  timePerQuestion       Int    @default(10)              // 舊欄位，向後相容
  timeChoiceQuestion    Int    @default(10)              // 選擇題時間（秒）
  timeSpellingQuestion  Int    @default(30)              // 拼寫題時間（秒）
  questionCount         Int    @default(0)
  questionTypes         Int[]  @default([0, 1, 2, 3])    // 預設啟用所有題型
}

// 自訂測驗
model CustomQuiz {
  id            String   @id @default(cuid())
  name          String                          // 測驗名稱
  fileId        String                          // 來源單字檔案
  wordIds       String[]                        // 選中的單字 ID
  questionTypes Int[]    @default([0, 1])       // 啟用的題型
  active        Boolean  @default(true)         // 是否啟用
  createdAt     DateTime @default(now())

  @@index([active])
}
